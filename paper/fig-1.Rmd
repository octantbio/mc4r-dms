```{r fig-1-setup}
knitr::opts_chunk$set(
  fig.path = "./fig-1/"
)
```

## Main Figures

## Extended Figures

### Library Dosing

```{r library-dosing, fig.width=9, fig.height=6}
library_luci <- bind_rows(
  Gq = read_tsv("../data/nfat-dosing.tsv"),
  Gs = read_tsv("../data/cre-dosing.tsv"),
  .id = "reporter"
)

library_luci_dmso <- library_luci %>%
  filter(conc == 0) %>%
  group_by(reporter, drug) %>%
  summarise(
    dmso = mean(luc),
    .groups = "drop"
  )

library_luci <- library_luci %>%
  filter(conc > 0) %>%
  inner_join(library_luci_dmso) %>%
  mutate(fold = luc / dmso)

conc_range <- library_luci %>%
  filter(conc > 0) %>%
  summarise(
    min = min(conc),
    max = max(conc)
  )

conc_vec <- exp(seq(log(conc_range$min), log(conc_range$max), length.out = 256))

# fix the lower term to 1 since we're in fold-change space
drc_helper <- function(df, formula) {
  drm(
    formula = formula,
    fct = LL2.4(
      names = c("Slope", "Lower", "Upper", "EC50"),
      fixed = c(NA, 1, NA, NA)
    ),
    data = df
  )
}

library_luci_drcs <- library_luci %>%
  nest(.by = c("reporter", "drug")) %>%
  mutate(
    drc = map(data, ~ drc_helper(.x, fold ~ conc)),
    coefs = map(drc, tidy),
    curve_fn = map(drc, ~ .x$curve[[1]]),
    conc = rep(list(conc_vec), n()),
    curve = map2(curve_fn, conc, ~ as.numeric(.x(.y)))
  )

library_luci_drcs %>%
  select(reporter, drug, data) %>%
  unnest(cols = data) %>%
  ggplot() +
  geom_hline(yintercept = 1, lty = "dashed") +
  geom_point(
    aes(x = conc, y = fold, color = drug)
  ) +
  geom_line(
    aes(x = conc, y = curve, color = drug),
    data = library_luci_drcs %>%
      select(reporter, drug, conc, curve) %>%
      unnest(cols = c(conc, curve))
  ) +
  facet_wrap(facets = vars(reporter)) +
  scale_x_log10(breaks = 10^seq(-11, -5)) +
  scale_color_manual(values = c("#1F77B4", "#FF7F0E")) +
  labs(
    x = "Concentration",
    y = "Fold change relative to DMSO",
    title = "Luciferase assay to determine DMS library dosing"
  ) +
  theme(
    legend.position = "bottom",
    legend.title = element_blank()
  )
```

### Effect of Barcodes

```{r barcode-downsample, fig.width=9, fig.height=4.5}
pos61p_downsample_sumstats <- read_tsv("./fig-1/MC4R-Downsample-Power-pos61P-downsample.tsv") %>%
  filter(mut_aa == "P")
pos90x_downsample_sumstats <- read_tsv("./fig-1/MC4R-Downsample-Power-pos90X-downsample.tsv") %>%
  filter(mut_aa == "*")

bind_rows(
  pos90x_downsample_sumstats %>% mutate(mut = "D90Stop"),
  pos61p_downsample_sumstats %>% mutate(mut = "E61P")
) %>%
  ggplot() +
  geom_pointrange(aes(
    x = as.factor(depth), y = estimate,
    ymin = estimate - 2 * std.error,
    ymax = estimate + 2 * std.error
  ), position = position_dodge2(width = 0.5)) +
  facet_wrap(~mut, nrow = 1) +
  geom_hline(yintercept = 0, lty = "dashed") +
  xlab("Number of Barcodes Per Sample") +
  ylab("Log2FoldChange\n+/- 2 Standard Errors")
```

### Correlation to Computational Predictions

```{r predictors, fig.width=10, fig.height=9}
alpha_missense <- read_tsv("../data/annotations/mc4r-alphamissense.tsv") %>%
  clean_names() %>%
  mutate(
    aa = str_sub(mut, start = -1, end = -1),
    pos = str_extract(mut, "\\d+") %>% as.numeric()
  )

alpha_missense_plot <- alpha_missense %>%
  mutate(score = -score + 1) %>%
  inner_join(cre) %>%
  filter(
    compound == "aMSH",
    dose == "low"
  ) %>%
  ggplot(aes(x = statistic, y = score)) +
  geom_point(pch = 21, alpha = 0.3) +
  labs(
    x = "DMS Z Score",
    y = "AlphaMissense score\n(0 = pathogenic, 1 = benign)"
  )

#-------------------------------------------------------------------------------

popeve <- read_csv("../data/annotations/mc4r-popeve.csv") %>%
  mutate(
    wt = str_sub(mutant, start = 1, end = 1),
    pos = str_extract(mutant, "\\d+") %>% as.numeric(),
    aa = str_sub(mutant, start = -1, end = -1)
  )

popeve_plot <- popeve %>%
  inner_join(cre) %>%
  filter(
    compound == "aMSH",
    dose == "low"
  ) %>%
  ggplot(aes(x = statistic, y = popEVE)) +
  geom_point(pch = 21, alpha = 0.3) +
  labs(
    x = "DMS Z Score",
    y = "popEVE Score"
  )

#-------------------------------------------------------------------------------

class_a <- read_tsv("../data/annotations/mc4r-class-a.tsv") %>%
  clean_names() %>%
  rename(class_a = cons, wt = wt_aa_short)

class_a_fit <- cre %>%
  filter(
    compound == "aMSH",
    dose == "low"
  ) %>%
  group_by(compound, dose, contrast, pos) %>%
  summarise(
    estimate = mean(log2FoldChange),
    z = mean(statistic),
    .groups = "drop"
  ) %>%
  inner_join(class_a) %>%
  augment(lm(class_a ~ z, data = .), data = .)

conservation_plot <- class_a_fit %>%
  ggplot() +
  geom_point(
    aes(x = z, y = class_a),
    pch = 21
  ) +
  geom_text_repel(
    aes(x = z, y = class_a, label = pos),
    data = filter(class_a_fit, .std.resid < -2),
    min.segment.length = 0,
    max.time = 2,
    force = 0.5,
    color = "red"
  ) +
  geom_line(aes(x = z, y = .fitted), linewidth = 1) +
  labs(
    x = "Mutational Tolerance Score",
    y = "Class-A GPCR Conservation"
  )

#-------------------------------------------------------------------------------

alpha_missense_plot +
  popeve_plot +
  conservation_plot +
  plot_layout(ncol = 2)
```


Write out aMSH data for both pathways with various predictors

```{r}
bind_rows(
  CRE = cre %>% filter(compound == "aMSH"),
  UAS = uas %>% filter(compound == "aMSH"),
  .id = "reporter"
) %>%
  mutate(
    pathway = if_else(reporter == "CRE", "Gs", "Gq")
  ) %>%
  clean_names() %>%
  select(reporter, pathway, compound, dose, chunk, pos, aa, log2fc = log2fold_change, std_error = log2std_error, statistic, p_value, p_adj) %>%
  left_join(alpha_missense) %>%
  rename(
    mutant = mut,
    am_score = score
  ) %>%
  relocate(mutant, .before = "pos") %>%
  select(-uniprot) %>%
  left_join(popeve) %>%
  relocate(wt, .before = "pos") %>%
  write_tsv("./fig-1/amsh-popeve-alphamissense.tsv")
```
